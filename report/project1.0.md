تمرین گروهی ۱/۰ - آشنایی با pintos
======================

شماره گروه:
-----
> نام و آدرس پست الکترونیکی اعضای گروه را در این قسمت بنویسید.

مهراد میلانلو mehrad_milanloo@yahoo.com

نام و نام خانوادگی <example@example.com> 

نام و نام خانوادگی <example@example.com> 

نام و نام خانوادگی <example@example.com> 

مقدمات
----------
> اگر نکات اضافه‌ای در مورد تمرین یا برای دستیاران آموزشی دارید در این قسمت بنویسید.


> لطفا در این قسمت تمامی منابعی (غیر از مستندات Pintos، اسلاید‌ها و دیگر منابع  درس) را که برای تمرین از آن‌ها استفاده کرده‌اید در این قسمت بنویسید.

آشنایی با pintos
============
>  در مستند تمرین گروهی ۱۹ سوال مطرح شده است. پاسخ آن ها را در زیر بنویسید.


## یافتن دستور معیوب

۱.
با توجه به فایل do-nothing.result، هنگام دسترسی به آدرس مجازی 0xc0000008، برنامه crash می‌کند.

۲.
آدرس مجازی دستوری که موجب crash شد،eip = 0x8048757 است.
دقت کنید که eip مخفف عبارت Extended Instruction Pointer است و برای دنبال کردن آدرس دستور فعلی که در برنامه اجرا می‌شود استفاده می‌شود.

۳.

با اجرای دستور زیر، کد اسمبلی فایل اجرایی do-nothing را تحلیل می‌کنیم.
objdump -drS do-nothing
سپس با بررسی آدرس‌های دستورها، متوجه می‌شویم که دستوری که موجع‌به crash شده، در تابع 
void _start (int argc, char *argv[]) {}
قرار دارد و اسمبلی دستور آن mov    0x24(%esp),%eax است.

۴.
کد C مربوطه در آدرس pintos/src/lib/user و در فایل entry.c وجود دارد. کد این تابع این‌گونه است:
void
_start (int argc, char *argv[]) {
  exit (main (argc, argv));}

  برای توضیح دستورات disassemble شده ابتدا Calling Convention در اسمبلی 80x86 را توضیح مختصری می‌دهیم.
  ابتدا Caller تمام آرگومان‌های تابع را در استک موردنظر Push می‌کند.استک نیز از بالا به پایین پر می‌شود و با هر پوش، اشاره‌گر استک کاهش می‌یابد. سپس Caller آدرس دستور بعدی خود را در استک تابع پوش می‌کند و به اولین دستور تابع صدا زده‌شده می‌پرد.اکنون تابع اجرا می‌شود و وقتی نوبت اجرای آن رسیده، اشاره‌گر به آدرس return اشاره می‌کند و آرگومان‌ها به‌ترتیب بالای آن قرار دارند. اگر تابع مقداری برای return داشته باشد، آن را در رجیستر eax ذخیره می‌کند. تابع نیز با Pop کردن مقدار return و پریدن به آدرس آن، از اسکوپ خود خارج می‌شود و آرگومان‌ها را نیز از استک Pop می‌کند.
  با توجه به توضیحات بالا، می‌توانیم دستورات اسمبلی را بهتر تحلیل کنیم. (دقت کنید که رجیستر esp همان Stack Pointer است و درباره‌ی عملکرد رجیستر eax توضیح داده شد.)
 8048754:	83 ec 1c             	sub    $0x1c,%esp
 8048757:	8b 44 24 24          	mov    0x24(%esp),%eax
 804875b:	89 44 24 04          	mov    %eax,0x4(%esp)
 804875f:	8b 44 24 20          	mov    0x20(%esp),%eax
 8048763:	89 04 24             	mov    %eax,(%esp)
 8048766:	e8 35 f9 ff ff       	call   80480a0 <main>
 804876b:	89 04 24             	mov    %eax,(%esp)
 804876e:	e8 49 1b 00 00       	call   804a2bc <exit>

 sub    $0x1c,%esp
 این خط اشاره‌گر استک را به مقدار ۲۸ بایت جابجا می‌کند و در واقع ۲۸ بایت به استک فضا می‌دهد.
 mov    0x24(%esp),%eax
 این دستور اولین آرگومان یعنی argc را در رجیستر eax ذخیره می‌کند.
 mov    %eax,0x4(%esp)
 اکنون با این دستور، مقدار eax را به‌عنوان آرگومان argc تابع main در استک ذخیره می‌کنیم.
 mov    0x20(%esp),%eax
 این دستور اولین آرگومان یعنی آدرس argv را در رجیستر eax ذخیره می‌کند.
 mov    %eax,(%esp)
 اکنون با این دستور، آدرس eax را به‌عنوان آرگومان argv تابع main در استک ذخیره می‌کنیم.
 call   80480a0 <main>
 این دستور به تابع main پرش می‌کند.
 (دقت کنید همانطور که در بالاتر توضیح دادیم، ابتدا مقدار return address را در استک ذخیره می‌کند.)
 mov    %eax,(%esp)
 این دستور خروجی تابع main که در رجیستر eax قرار می‌گیرد را به‌عنوان آرگومان تابع exit در استک ذخیره می‌کند.
 call   804a2bc <exit>
 با این دستور، تابع exit فراخوانی می‌شود.


۵.
در سیستم‌عامل PintOS اجرای برنامه‌های کاربر از تابع _start شروع می‌شود. بنابراین در استک این تابع ورودی‌های آن پوش نشده‌اند. به‌همین خاطر برای دسترسی به مقادیر آرگومان‌های argc و argv به‌اندازه‌ی ۳۶ بایت رو به بالا حرکت می‌کند.  دقت کنید در سیستم‌عامل PintOS، حافظه‌ی مجازی به دو قسمت تقسیم می‌شود. قسمت اول که از آدرس 0 تا PHYS_BASE است، مربوط به فضای کرنل است. از آن به بعد نیز مربوط به فضای کاربر است. به‌طور دیفالت برنامه‌ی کاربر که شروع می‌شود،‌از آدرس دیفالت 0xc0000008 است. همانطور که گفتیم بعد از اختصاص ۲۸ بایت به استک و پایین آمدن در استک، به مقدار ۳۶ بایت رو به بالا حرکت می‌کند که باعث می‌شود مرز User Space و Kernel Space را رد کند که سبب Page Fault: rights violation error می‌شود.

## به سوی crash

۶.

۷.

۸.

۹.

۱۰.

۱۱.

۱۲.

۱۳.


## دیباگ

۱۴.

۱۵.

۱۶.

۱۷.

۱۸.

۱۹.